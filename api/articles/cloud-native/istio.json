{"title":"istio 从入门到入土","uid":"3b63f2fddd88d6903dbde299ee7b6a3e","slug":"cloud-native/istio","date":"2022-07-17T17:59:14.000Z","updated":"2022-08-16T08:21:58.286Z","comments":true,"path":"api/articles/cloud-native/istio.json","keywords":null,"cover":null,"content":"<h1 id=\"Istio-从入门到入土\"><a href=\"#Istio-从入门到入土\" class=\"headerlink\" title=\"Istio 从入门到入土\"></a>Istio 从入门到入土</h1><h2 id=\"流量管理\"><a href=\"#流量管理\" class=\"headerlink\" title=\"流量管理\"></a>流量管理</h2><p>Istio 的流量路由规则可让您轻松控制服务之间的流量和 API 调用。Istio 简化了断路器、超时和重试等服务级别属性的配置，并可以轻松设置重要任务，例如 A&#x2F;B 测试、金丝雀发布和基于百分比的流量拆分的分阶段发布。它还提供开箱即用的可靠性功能，帮助您的应用程序更灵活地应对依赖服务或网络的故障。</p>\n<p>Istio 的流量管理模型依赖于使者 与您的服务一起部署的代理。您的网格服务发送和接收的所有流量（数据平面流量）通过 Envoy 代理，从而可以轻松地引导和控制网格周围的流量，而无需对服务进行任何更改。</p>\n<p>如果您对本指南中描述的功能如何工作的详细信息感兴趣，可以在 <a href=\"https://istio.io/latest/docs/ops/deployment/architecture/\">架构概述</a>中找到有关 Istio 流量管理实现的更多信息。本指南的其余部分介绍了 Istio 的流量管理功能。</p>\n<h3 id=\"虚拟服务\"><a href=\"#虚拟服务\" class=\"headerlink\" title=\"虚拟服务\"></a>虚拟服务</h3><p>最基础的路由功能单位，每个虚拟服务都会有一系列路由规则组成，istio会按顺序执行匹配这些规则来路由请求。</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: networking.istio.io&#x2F;v1alpha3\nkind: VirtualService\nmetadata:\n  name: reviews\nspec:\n  hosts:\n  - reviews\n  http:\n  - match:\n    - headers:\n        end-user:\n          exact: jason\n    route:\n    - destination:\n        host: reviews\n        subset: v2\n  - route:\n    - destination:\n        host: reviews\n        subset: v3</code></pre>\n\n<h3 id=\"目的规则\"><a href=\"#目的规则\" class=\"headerlink\" title=\"目的规则\"></a>目的规则</h3><p>目的地规则是在虚拟服务规则执行后，引导流量。<br>例如可以定义你的多个版本的服务的实际路由规则</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: networking.istio.io&#x2F;v1alpha3\nkind: DestinationRule\nmetadata:\n  name: my-destination-rule\nspec:\n  host: my-svc\n  trafficPolicy:\n    loadBalancer:\n      simple: RANDOM\n  subsets:\n  - name: v1\n    labels:\n      version: v1\n  - name: v2\n    labels:\n      version: v2\n    trafficPolicy:\n      loadBalancer:\n        simple: ROUND_ROBIN\n  - name: v3\n    labels:\n      version: v3</code></pre>\n\n<h3 id=\"网关\"><a href=\"#网关\" class=\"headerlink\" title=\"网关\"></a>网关</h3><p>管理网格中出入流量，控制何种流量可以流出以及流入。网关配置只会应用给网格边缘运行的单节点Envoy代理，而不会发送给服务负载的Envoy边车代理。提供4-7层网络控制。<br>通过网关配置egress规则，决定服务是否可以与外部通信，提供更高安全管控能力。</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: networking.istio.io&#x2F;v1alpha3\nkind: Gateway\nmetadata:\n  name: ext-host-gwy\nspec:\n  selector:\n    app: my-gateway-controller\n  servers:\n  - port:\n      number: 443\n      name: https\n      protocol: HTTPS\n    hosts:\n    - ext-host.example.com\n    tls:\n      mode: SIMPLE\n      credentialName: ext-host-cert</code></pre>\n\n<h3 id=\"服务入口\"><a href=\"#服务入口\" class=\"headerlink\" title=\"服务入口\"></a>服务入口</h3><p>通过声明服务入口，可以像内部服务一样使用管理外部服务。<br>你不需要为每个外部服务做此声明，但是这样将不能使用istio特性来控制这些服务的流量。</p>\n<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: networking.istio.io&#x2F;v1alpha3\nkind: ServiceEntry\nmetadata:\n  name: svc-entry\nspec:\n  hosts:\n  - ext-svc.example.com\n  ports:\n  - number: 443\n    name: https\n    protocol: HTTPS\n  location: MESH_EXTERNAL\n  resolution: DNS</code></pre>\n\n<h3 id=\"边车\"><a href=\"#边车\" class=\"headerlink\" title=\"边车\"></a>边车</h3><p>istio默认每个envoy代理接受并转发负载所有端口上的流量。你可以使用sidecar配置来达到以下效果:</p>\n<ul>\n<li>调优Envoy代理接受的端口和协议</li>\n<li>限制Envoy可以达到的服务<pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: networking.istio.io&#x2F;v1alpha3\nkind: Sidecar\nmetadata:\n  name: default\n  namespace: bookinfo\nspec:\n  egress:\n  - hosts:\n    - &quot;.&#x2F;*&quot;\n    - &quot;istio-system&#x2F;*&quot;</code></pre></li>\n</ul>\n<h3 id=\"网络故障恢复和验证\"><a href=\"#网络故障恢复和验证\" class=\"headerlink\" title=\"网络故障恢复和验证\"></a>网络故障恢复和验证</h3><p>istio不仅提供了以上的流量管理能力，同样提供了动态可选的故障回复和错误注入特性。运用这些特性可以促成你的服务更加可靠。</p>\n<h4 id=\"超时\"><a href=\"#超时\" class=\"headerlink\" title=\"超时\"></a>超时</h4><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: networking.istio.io&#x2F;v1alpha3\nkind: VirtualService\nmetadata:\n  name: ratings\nspec:\n  hosts:\n  - ratings\n  http:\n  - route:\n    - destination:\n        host: ratings\n        subset: v1\n    timeout: 10s</code></pre>\n\n<h4 id=\"重试\"><a href=\"#重试\" class=\"headerlink\" title=\"重试\"></a>重试</h4><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: networking.istio.io&#x2F;v1alpha3\nkind: VirtualService\nmetadata:\n  name: ratings\nspec:\n  hosts:\n  - ratings\n  http:\n  - route:\n    - destination:\n        host: ratings\n        subset: v1\n    retries:\n      attempts: 3\n      perTryTimeout: 2s</code></pre>\n\n<h4 id=\"熔断\"><a href=\"#熔断\" class=\"headerlink\" title=\"熔断\"></a>熔断</h4><pre class=\"line-numbers language-yaml\" data-language=\"yaml\"><code class=\"language-yaml\">apiVersion: networking.istio.io&#x2F;v1alpha3\nkind: DestinationRule\nmetadata:\n  name: reviews\nspec:\n  host: reviews\n  subsets:\n  - name: v1\n    labels:\n      version: v1\n    trafficPolicy:\n      connectionPool:\n        tcp:\n          maxConnections: 100\n</code></pre>\n\n<h2 id=\"通信安全\"><a href=\"#通信安全\" class=\"headerlink\" title=\"通信安全\"></a>通信安全</h2><p>支持TLS</p>\n<h2 id=\"可见性\"><a href=\"#可见性\" class=\"headerlink\" title=\"可见性\"></a>可见性</h2><ul>\n<li>属性<pre class=\"line-numbers language-none\"><code class=\"language-none\">envoy_cluster_internal_upstream_rq&#123;response_code_class&#x3D;&quot;2xx&quot;,cluster_name&#x3D;&quot;xds-grpc&quot;&#125; 7163\n\nenvoy_cluster_upstream_rq_completed&#123;cluster_name&#x3D;&quot;xds-grpc&quot;&#125; 7164\n\nenvoy_cluster_ssl_connection_error&#123;cluster_name&#x3D;&quot;xds-grpc&quot;&#125; 0\n\nenvoy_cluster_lb_subsets_removed&#123;cluster_name&#x3D;&quot;xds-grpc&quot;&#125; 0\n\nenvoy_cluster_internal_upstream_rq&#123;response_code&#x3D;&quot;503&quot;,cluster_name&#x3D;&quot;xds-grpc&quot;&#125; 1</code></pre></li>\n<li>分布式跟踪</li>\n<li>日志</li>\n</ul>\n<h2 id=\"拓展性\"><a href=\"#拓展性\" class=\"headerlink\" title=\"拓展性\"></a>拓展性</h2>","text":"Istio 从入门到入土流量管理Istio 的流量路由规则可让您轻松控制服务之间的流量和 API 调用。Istio 简化了断路器、超时和重试等服务级别属性的配置，并可以轻松设置重要任务，例如 A&#x2F;B 测试、金丝雀发布和基于百分比的流量拆分的分阶段发布。它还提供开箱即用的...","link":"","photos":[],"count_time":{"symbolsCount":"3.6k","symbolsTime":"3 mins."},"categories":[{"name":"cloud-native","slug":"cloud-native","count":7,"path":"api/categories/cloud-native.json"}],"tags":[{"name":"CloudNative","slug":"CloudNative","count":5,"path":"api/tags/CloudNative.json"},{"name":"istio","slug":"istio","count":1,"path":"api/tags/istio.json"},{"name":"ServiceMesh","slug":"ServiceMesh","count":2,"path":"api/tags/ServiceMesh.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-1\"><a class=\"toc-link\" href=\"#Istio-%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F\"><span class=\"toc-text\">Istio 从入门到入土</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%B5%81%E9%87%8F%E7%AE%A1%E7%90%86\"><span class=\"toc-text\">流量管理</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%99%9A%E6%8B%9F%E6%9C%8D%E5%8A%A1\"><span class=\"toc-text\">虚拟服务</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%9B%AE%E7%9A%84%E8%A7%84%E5%88%99\"><span class=\"toc-text\">目的规则</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%BD%91%E5%85%B3\"><span class=\"toc-text\">网关</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E6%9C%8D%E5%8A%A1%E5%85%A5%E5%8F%A3\"><span class=\"toc-text\">服务入口</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E8%BE%B9%E8%BD%A6\"><span class=\"toc-text\">边车</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E7%BD%91%E7%BB%9C%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D%E5%92%8C%E9%AA%8C%E8%AF%81\"><span class=\"toc-text\">网络故障恢复和验证</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E8%B6%85%E6%97%B6\"><span class=\"toc-text\">超时</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E9%87%8D%E8%AF%95\"><span class=\"toc-text\">重试</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#%E7%86%94%E6%96%AD\"><span class=\"toc-text\">熔断</span></a></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E9%80%9A%E4%BF%A1%E5%AE%89%E5%85%A8\"><span class=\"toc-text\">通信安全</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%8F%AF%E8%A7%81%E6%80%A7\"><span class=\"toc-text\">可见性</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%8B%93%E5%B1%95%E6%80%A7\"><span class=\"toc-text\">拓展性</span></a></li></ol></li></ol>","author":{"name":"Stephen Ling","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"Think twice, code once!","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"服务网格","uid":"44e4ec9f11dd82491daf05435d1368ad","slug":"cloud-native/service-mesh","date":"2022-07-17T18:04:02.000Z","updated":"2022-08-16T08:21:58.286Z","comments":true,"path":"api/articles/cloud-native/service-mesh.json","keywords":null,"cover":null,"text":"服务网格什么是服务网格?服务网格（例如开源项目 Istio）用于控制应用的不同部分之间如何共享数据。与用于管理此类通信的其他系统不同，服务网格内置于应用程序中的专用基础架构层。这个可见的基础架构层可以记录应用的不同部分是否能正常交互。因此，随着应用的不断发展，它在优化通信和避免停...","link":"","photos":[],"count_time":{"symbolsCount":"1.3k","symbolsTime":"1 mins."},"categories":[{"name":"cloud-native","slug":"cloud-native","count":7,"path":"api/categories/cloud-native.json"}],"tags":[{"name":"CloudNative","slug":"CloudNative","count":5,"path":"api/tags/CloudNative.json"},{"name":"ServiceMesh","slug":"ServiceMesh","count":2,"path":"api/tags/ServiceMesh.json"}],"author":{"name":"Stephen Ling","slug":"blog-author","avatar":"https://img-blog.csdnimg.cn/20210313122054101.png","link":"/","description":"Think twice, code once!","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{}}